name: Build on Sync

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      create_release:
        description: 'åˆ›å»º GitHub Release'
        required: false
        type: boolean
        default: true

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    
    env:
      CI: false
      # æ³¨æ„ï¼šå¦‚éœ€å¯ç”¨è‡ªåŠ¨æ›´æ–°ç­¾åï¼Œè¯·åœ¨ä»“åº“ Secrets ä¸­é…ç½® TAURI_PRIVATE_KEY å’Œ TAURI_KEY_PASSWORD
      # TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
      # TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version info
        id: version
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          TAG_COUNT=$(git tag -l "v${VERSION}.*" | wc -l)
          NEXT_NUM=$((TAG_COUNT + 1))
          FULL_VERSION="${VERSION}.${NEXT_NUM}"
          GIT_HASH=$(git rev-parse --short HEAD)
          GIT_DESC="v${FULL_VERSION}-${GIT_HASH}"
          # GitHub Actions è¿è¡Œåœ¨ UTC ç¯å¢ƒï¼Œæ‰‹åŠ¨åŠ  8 å°æ—¶
          BUILD_TIME=$(date -u -d '+8 hours' +'%Y-%m-%d %H:%M:%S UTC+8')
          echo "version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "git_desc=$GIT_DESC" >> $GITHUB_OUTPUT
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "file_prefix=EcoPaste_${FULL_VERSION}" >> $GITHUB_OUTPUT

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Windows app (x64)
        run: pnpm tauri build --target x86_64-pc-windows-msvc

      - name: Rename artifacts
        shell: bash
        run: |
          mkdir -p dist
          cp target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe "dist/${{ steps.version.outputs.file_prefix }}_x64-setup.exe"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-build
          path: dist/*.exe
          retention-days: 7
          compression-level: 0

      - name: Create Release
        if: github.event.inputs.create_release != 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: "EcoPaste_v${{ steps.version.outputs.version }}"
          body: |
            ## EcoPaste Plus å¢å¼ºç‰ˆ
            
            åŸºäºå®˜æ–¹ EcoPaste çš„å¢å¼º Fork ç‰ˆæœ¬ï¼ŒåŒ…å«ä»¥ä¸‹æ”¹è¿›ï¼š
            
            ### ğŸ†• M04 é‡å¤§æ›´æ–°
            - **WebDAV å¤‡ä»½è‡ªåŠ¨è°ƒåº¦å¼•æ“**ï¼šå†…ç½®å…¨æ–°ä»»åŠ¡è°ƒåº¦å™¨ï¼Œæ”¯æŒå¤šç§å®šæ—¶è§„åˆ™ï¼Œç‹¬ç«‹ç®¡æ§â€œç²¾ç®€â€ä¸â€œå®Œæ•´â€å¤‡ä»½åŒçº¿æµç¨‹
            - **Markdown æ™ºèƒ½è¯†åˆ«ä¸ç¼–è¾‘**ï¼šç‹¬åˆ›è®¡åˆ†æƒé‡ç®—æ³•ç²¾å‡†æå– Markdownï¼Œå¹¶æä¾›ä¸“å±çš„æ ¼å¼åŒ–æ²‰æµ¸å¼ç¼–è¾‘ä½“éªŒ
            - **å›¾ç‰‡å¿«é€Ÿå®šä½**ï¼šæ”¯æŒä¸€é”®æ‹‰èµ·ç³»ç»Ÿèµ„æºç®¡ç†å™¨ï¼Œç²¾å‡†å®šæ ¼æ˜¾ç¤ºå›¾ç‰‡åŸæœ¬åœ°æ–‡ä»¶
            - **WebDAV ä½“éªŒå…¨å¼‚æ­¥åŒ–ä¸å…¼å®¹é‡æ„**ï¼šéª¨æ¶å±ä¸ Loading æœºåˆ¶å½»åº•è§£å†³æ•°æ®æ‹‰å–æ—¶çš„ç•Œé¢å‡æ­»ï¼Œå¹¶é€šè¿‡ä¸´æ—¶éš”ç¦»åŒºæŠ€æœ¯å®ç°ä¸æœ¬åœ°â€œå¯¼å…¥æ•°æ®â€çš„ç»“æ„å…¨äº’é€šå…¼å®¹
            - **è·¨ç«¯ç›®å½•æ¢æµ‹**ï¼šRust é’©å­è‡ªé€‚åº”æ¢é€šå¹¶æ–°å»ºé€’å½’äº‘ç«¯ä¸Šçº§ç›®å½•ï¼Œé˜»æ­¢ WebDAV æ¢å¤å¤‡ä»½æ—¶çš„ 405 Method Not Allowed
            - **åº•å±‚ç¼ºé™·ä¿®å¤**ï¼šä¸¥å¯†ä¿®å¤ä» Excel å¤åˆ¶å•å…ƒæ ¼è¢«å›¾æ–‡å¤åˆæƒè¯¯åˆ¤é™çº§ä¸ºå›¾ç‰‡çš„é—ç•™é—®é¢˜ï¼Œé˜²å¾¡ä¿®å¤ SQLite ç©ºç™½å­—æ®µé€ æˆçš„åºåˆ—åŒ–å¤‡ä»½æˆªæ–­ä¸­æ–­ç‚¹
            
            ### âœ¨ è¿‡å¾€æ ¸å¿ƒç‰¹æ€§å½’çº³
            - æ”¯æŒ WebDAV æ‰‹åŠ¨åŸºç¡€äº‘å¤‡ä»½æ¢å¤ (M03)ï¼Œæä¾›å›¾ç‰‡åˆ é™¤æ—¶å¯é€‰ä¸æ¸…ç†æœ¬åœ°åŸæ–‡ä»¶
            - â€œé“¾æ¥â€â€œé¢œè‰²â€â€œä»£ç â€åŸç”Ÿå‘½ä¸­ç¾¤ç»„åˆ†ç±»æå–ï¼Œä»¥åŠåŸå§‹åº”ç”¨å›¾æ ‡æ¥æºè¿½æº¯ (M02)
            - å¯Œæ–‡æœ¬ä¸å›¾ç‰‡çš„å¤§å¼¹çª—æ²‰æµ¸ç‹¬ç«‹ç¼–è¾‘æ¡†ï¼Œå¹¶é…æœ‰åª²ç¾ IDE çš„ä»£ç ç‰‡æ®µè¯­æ³•é«˜äº®å…¨å½©è¯†åˆ« (M02)
            - ä¸»ç¨‹åºæ”¯æŒä¸å¤ºç„¦é™é»˜çº¯åå°å‘¼å‡ºã€è´´å›¾è‡ªåŠ¨è·Ÿéšè¾“å…¥å…‰æ ‡ï¼Œåˆ—è¡¨é¡¹è¡Œé«˜åŠé•¿æ–‡å›¾ç‰‡è·¨æ»šåŠ¨æŠ˜å çŠ¶æ€è®°å½• (M01/M02)
            - å¼ºåŠ›æ¥ç®¡è§£å†³åŸç‰ˆå®˜æ–¹æ ¸å¿ƒæ— æ³•å‘ç³»ç»Ÿä»»ä½•è‡ªå®šä¹‰è·¯å¾„æˆåŠŸå­˜ç›˜æˆªå±å›¾ç‰‡çš„è‡´å‘½çº¢å‰ Bug (M01)
            
            ### ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
            - **ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}
            - **æ„å»ºæ—¶é—´**: ${{ steps.version.outputs.build_time }}
            - **Git æè¿°**: ${{ steps.version.outputs.git_desc }}
            
            ### âš ï¸ æ³¨æ„äº‹é¡¹
            - æ­¤ç‰ˆæœ¬ç¦ç”¨äº†è‡ªåŠ¨æ›´æ–°åŠŸèƒ½ï¼Œé¿å…ä¸å®˜æ–¹ç‰ˆæœ¬å†²çª
            - é…ç½®æ–‡ä»¶ä¸å®˜æ–¹ç‰ˆæœ¬å…¼å®¹ï¼Œå¯ç›´æ¥æ›¿æ¢ä½¿ç”¨
          draft: false
          prerelease: true
          files: dist/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
