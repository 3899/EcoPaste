name: Build on Sync

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      create_release:
        description: '创建 GitHub Release'
        required: false
        type: boolean
        default: true

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    
    env:
      CI: false
      # 注意：如需启用自动更新签名，请在仓库 Secrets 中配置 TAURI_PRIVATE_KEY 和 TAURI_KEY_PASSWORD
      # TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
      # TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version info
        id: version
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          TAG_COUNT=$(git tag -l "v${VERSION}.*" | wc -l)
          NEXT_NUM=$((TAG_COUNT + 1))
          FULL_VERSION="${VERSION}.${NEXT_NUM}"
          GIT_HASH=$(git rev-parse --short HEAD)
          GIT_DESC="v${FULL_VERSION}-${GIT_HASH}"
          # GitHub Actions 运行在 UTC 环境，手动加 8 小时
          BUILD_TIME=$(date -u -d '+8 hours' +'%Y-%m-%d %H:%M:%S UTC+8')
          echo "version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "git_desc=$GIT_DESC" >> $GITHUB_OUTPUT
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "file_prefix=EcoPaste_${FULL_VERSION}" >> $GITHUB_OUTPUT

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Windows app (x64)
        run: pnpm tauri build --target x86_64-pc-windows-msvc

      - name: Rename artifacts
        shell: bash
        run: |
          mkdir -p dist
          cp target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe "dist/${{ steps.version.outputs.file_prefix }}_x64-setup.exe"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-build
          path: dist/*.exe
          retention-days: 7
          compression-level: 0

      - name: Create Release
        if: github.event.inputs.create_release != 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: "EcoPaste_v${{ steps.version.outputs.version }}"
          body: |
            ## EcoPaste-Pro 增强版
            
            基于官方 EcoPaste 的增强 Fork 版本，包含以下改进：
            
            ### ✨ M04.6
            - **🐞 bug修复**：修复了剪贴板窗口快速连续切换分组时内容显示不正确的竞态条件问题。

            ### 📜 M04.5
            - **🏗️ 架构优化**：结合单例查询驱动与严格深拷贝赋值，解决版本降级时因 DB/Config 结构不兼容产生的渲染崩溃。
            - **💫 体验优化**：统一返回顶部按钮右下边距，调优拖拽选取文本蓝白高亮色调。
            - **🐞 bug修复**：修复当 `autoSort` 开启时来源应用信息被当前焦点应用错误覆盖的问题。

            ### 📜 M04.4
            - **✂️ 支持文本片段选取**：新增剪贴板窗口部分文本选取功能，可通过浮动工具栏与右键菜单操作，并配备独立控制开关。

            ### 📜 M04.3
            - **🎨 新增CMYK颜色识别**：新增对 CMYK 颜色格式的智能提取与可视预览。
            - **🖱️ 右键菜单全面重构**：按复制、操作、编辑进行功能逻辑分组；依据操作流程与频次重排展示层级；并为 12 种不同内容格式量身定制了特有的专属右键操作项。
            - **🐞 完善优化与 Bug 修复**：补齐偏好设置中对"运行"菜单按钮的独立操控权；彻底修复了在`颜色`分组下，新拷贝的色块不能即时置首展现的画面停滞死区。

            ### 📜 M04.2
            - **🔍 Windows 路径与指令智能识别**：自动识别环境变量路径 (%APPDATA% 等)、Shell 文件夹 (shell:startup 等)、文件系统路径 (C:\Windows 等) 和管理工具指令 (regedit 等)，支持一键快速打开或运行
            - **🔄 配置文件自动同步**：偏好设置变更时自动同步到用户自定义目录，确保备份配置始终最新
            
            ### 📜 M04.1
            - **WebDAV 备份自动调度引擎**：内置全新任务调度器，支持多种定时规则，独立管控“精简”与“完整”备份双线流程
            - **Markdown 智能识别与编辑**：独创计分权重算法精准提取 Markdown，并提供专属的格式化沉浸式编辑体验
            - **图片快速定位**：支持一键拉起系统资源管理器，精准定格显示图片原本地文件
            - **WebDAV 体验全异步化与兼容重构**：骨架屏与 Loading 机制彻底解决数据拉取时的界面假死，并通过临时隔离区技术实现与本地“导入数据”的结构全互通兼容
            - **跨端目录探测**：Rust 钩子自适应探通并新建递归云端上级目录，阻止 WebDAV 恢复备份时的 405 Method Not Allowed
            - **底层缺陷修复**：严密修复从 Excel 复制单元格被图文复合权误判降级为图片的遗留问题，防御修复 SQLite 空白字段造成的序列化备份截断中断点
            
            ### 🕒 过往版本核心特性归纳
            - 支持基于 WebDAV 的云备份与恢复，且各项敏感核心配置均已对接 Windows 系统底层自带的凭据管理器安全护航 (M03)，并提供图片可选不清理本地原文件的独立管理 (M03)
            - “链接”“颜色”“代码”原生命中群组分类提取，以及原始应用图标来源追溯 (M02)
            - 富文本与图片的大弹窗沉浸独立编辑框，并配有媲美 IDE 的代码片段语法高亮全彩识别 (M02)
            - 主程序支持不夺焦静默纯后台呼出、贴图自动跟随输入光标，列表项行高及长文图片跨滚动折叠状态记录 (M01/M02)
            - 强力接管解决原版官方核心无法向系统任何自定义路径成功存盘截屏图片的致命红叉 Bug (M01)
            
            ### 📋 版本信息
            - **版本**: ${{ steps.version.outputs.version }}
            - **构建时间**: ${{ steps.version.outputs.build_time }}
            - **Git 描述**: ${{ steps.version.outputs.git_desc }}
            
            ### ⚠️ 注意事项
            - 此版本禁用了自动更新功能，避免与官方版本冲突
            - 配置文件与官方版本兼容，可直接替换使用
          draft: false
          prerelease: true
          files: dist/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
