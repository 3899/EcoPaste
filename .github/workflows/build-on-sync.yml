name: Build on Sync

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      create_release:
        description: 'åˆ›å»º GitHub Release'
        required: false
        type: boolean
        default: true

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    
    env:
      CI: false
      # æ³¨æ„ï¼šå¦‚éœ€å¯ç”¨è‡ªåŠ¨æ›´æ–°ç­¾åï¼Œè¯·åœ¨ä»“åº“ Secrets ä¸­é…ç½® TAURI_PRIVATE_KEY å’Œ TAURI_KEY_PASSWORD
      # TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
      # TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version info
        id: version
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          FULL_VERSION="${VERSION}.${{ github.run_number }}"
          GIT_HASH=$(git rev-parse --short HEAD)
          GIT_DESC="v${FULL_VERSION}-${GIT_HASH}"
          # GitHub Actions è¿è¡Œåœ¨ UTC ç¯å¢ƒï¼Œæ‰‹åŠ¨åŠ  8 å°æ—¶
          BUILD_TIME=$(date -u -d '+8 hours' +'%Y-%m-%d %H:%M:%S UTC+8')
          echo "version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "git_desc=$GIT_DESC" >> $GITHUB_OUTPUT
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "file_prefix=EcoPaste_${FULL_VERSION}" >> $GITHUB_OUTPUT

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Windows app (x64)
        run: pnpm tauri build --target x86_64-pc-windows-msvc

      - name: Rename artifacts
        shell: bash
        run: |
          mkdir -p dist
          cp target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe "dist/${{ steps.version.outputs.file_prefix }}_x64-setup.exe"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-build
          path: dist/*.exe
          retention-days: 7
          compression-level: 0

      - name: Create Release
        if: github.event.inputs.create_release != 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: "EcoPaste_v${{ steps.version.outputs.version }}"
          body: |
            ## EcoPaste Plus å¢å¼ºç‰ˆ
            
            åŸºäºå®˜æ–¹ EcoPaste çš„å¢å¼º Fork ç‰ˆæœ¬ï¼ŒåŒ…å«ä»¥ä¸‹æ”¹è¿›ï¼š
            
            ### âœ¨ å¢å¼ºåŠŸèƒ½
            - **WebDAV äº‘ç«¯å¤‡ä»½**ï¼šæ”¯æŒé€šè¿‡ WebDAV åè®®å¤‡ä»½åˆ°åšæœäº‘/NextCloudç­‰ï¼Œç²¾ç®€å¤‡ä»½ã€è‡ªåŠ¨å®šæ—¶ã€æ•°é‡é™åˆ¶ã€ä¸€é”®æ¢å¤
            - **ç‹¬ç«‹ç¾¤ç»„ä¸é¢œè‰²è¯†åˆ«**ï¼šæ–°å¢ "é“¾æ¥"ã€"é¢œè‰²"ã€"ä»£ç "ã€"é‚®ç®±" ç¾¤ç»„åˆ†ç±»ï¼Œç²¾å‡†æå–å¹¶é«˜äº® RGB/RGBA é¢œè‰²
            - **ä¸°å¯ŒäºŒæ¬¡ç¼–è¾‘**ï¼šæ”¯æŒæ–‡æœ¬ç­‰å¯Œå†…å®¹æ•°æ®çš„ç‹¬ç«‹å¼¹çª—ç¼–è¾‘ä¸ç›´æ¥æ–‡ä»¶å®šä½
            - **é«˜äº®ä»£ç è¯­æ³•é¢„è§ˆ**ï¼šè‡ªåŠ¨ä¾¦æµ‹ä»£ç ç‰‡æ®µå¹¶æ¸²æŸ“ IDE çº§è¯­æ³•é«˜äº®
            - **æ•°æ®æ¥æºæˆªå–**ï¼šæ¥æº App å›¾æ ‡/åç§°è·å–
            - **åŸç”Ÿå¿«é€Ÿè®¿é—®**ï¼šæ”¯æŒèµ„æºç®¡ç†å™¨æ‰“å¼€è·¯å¾„ã€æµè§ˆå™¨æ‰“å¼€é“¾æ¥ã€è°ƒç”¨ç³»ç»Ÿå›¾ç‰‡æŸ¥çœ‹å™¨
            - **æ–‡æœ¬/å›¾ç‰‡æ˜¾ç¤ºé€‚é…**ï¼šçµæ´»è°ƒæ•´æ–‡æœ¬/ä»£ç /æ–‡ä»¶æ˜¾ç¤ºè¡Œæ•°å’Œå›¾ç‰‡é«˜åº¦ï¼Œå±•å¼€/æ”¶èµ·çŠ¶æ€è·¨æ»šåŠ¨ä¿æŒ
            - **æ™ºèƒ½åˆ é™¤ç¡®è®¤**ï¼šåˆ é™¤å›¾ç‰‡æ—¶å¯é€‰ä¿ç•™æœ¬åœ°æ–‡ä»¶
            
            ### ğŸ› åŸç‰ˆä¿®å¤
            - **æˆªå±å®Œç¾è½¬å‚¨**ï¼šé‡æ„ SQLite æ—¥å¿—è¡Œä¸ºåŠåº•å±‚ FS æ˜ å°„é“¾è·¯ï¼Œå›¾ç‰‡å®Œç¾ä¿å­˜è‡³è‡ªå®šä¹‰è·¯å¾„ï¼Œä¿®æ­£è‡ªå»ºç›®å½•å´©æºƒä¸”å›¾ç‰‡çº¢å‰çš„é—®é¢˜
            - **å‰ªè´´æ¿ç±»å‹è¯¯åˆ¤**ï¼šå½»åº•ä¿®å¤ç½‘ç»œå›¾ç‰‡è¢«é”™è¯¯è¯†åˆ«ä¸º HTML çš„é—®é¢˜
            - **å¤åˆ¶é“¾æ¥åŒé‡è®°å½•**ï¼šå½»åº•ä¿®å¤å¤åˆ¶é“¾æ¥æ—¶äº§ç”Ÿé‡å¤è®°å½•çš„é—®é¢˜
            - **æ•°æ®å¤‡ä»½å…¥å£ç¼ºå¤±**ï¼šé‡æ–°å±•ç¤ºå¤‡ä»½åŠŸèƒ½å…¥å£
            
            ### ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
            - **ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}
            - **æ„å»ºæ—¶é—´**: ${{ steps.version.outputs.build_time }}
            - **Git æè¿°**: ${{ steps.version.outputs.git_desc }}
            
            ### âš ï¸ æ³¨æ„äº‹é¡¹
            - æ­¤ç‰ˆæœ¬ç¦ç”¨äº†è‡ªåŠ¨æ›´æ–°åŠŸèƒ½ï¼Œé¿å…ä¸å®˜æ–¹ç‰ˆæœ¬å†²çª
            - é…ç½®æ–‡ä»¶ä¸å®˜æ–¹ç‰ˆæœ¬å…¼å®¹ï¼Œå¯ç›´æ¥æ›¿æ¢ä½¿ç”¨
          draft: false
          prerelease: true
          files: dist/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
